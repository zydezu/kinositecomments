<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Comments</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon"/> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/9.8.1/firebase-app-compat.js"></script> <!-- import firebase SDK -->
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/9.8.1/firebase-firestore-compat.js"></script> <!-- import firebase firestore SDK -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
  </head>

  <body onload="checkUUID()"> <!-- get user UUID -->
    <div id="title"><span style="font-size: 20px;"><b>Comments</b></span> <span style="font-size: 15px;" id="commentCount">0</span></div>

    <form>
      <div class="namebox">
          <input type="text" placeholder="Name" id="nickname" minlength=0 maxlength=16> <output id="length">0/1024</output>
      </div>
      <div class="commentbox" oninput="checkLength()">
        <textarea placeholder="Type your comment here..." id="comment" maxlength=1024 required></textarea>
      </div>
      <div class="send">
        <button type="submit">Send</button>
      </div>
    </form>

    <section class="comments">
      <div id="loaddata">
        <p>Loading comments...</p>
      </div>
    </section>

    <script>
      //adjust page height when resizing
      var textarea = document.getElementById("comment");
      var maxTextAreaHeight = 500;
      window.addEventListener("resize", sendHeightMessage);       
      new ResizeObserver(sendHeightMessage).observe(textarea);

      //adjust height of the textarea when typing in it
      function sendHeightMessage() {window.parent.postMessage(Math.max(250, document.body.scrollHeight + 50), "*")}
      textarea.addEventListener("input", adjustTextAreaSize);
      function adjustTextAreaSize(){
        textarea.style.height = "";
        textarea.style.height = Math.min(textarea.scrollHeight, maxTextAreaHeight) + "px";
      }

      function getPage() {
        return (new URL(window.location.href)).searchParams.get("page");
      }

      function checkUUID() {
        if (localStorage.ID) { //check if device has an ID stored in cookie
          var UUID = localStorage.ID;
        } else {
          function uuidv4() {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
              (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16) //generate random UUID
            );
          }
          var UUID = uuidv4();
          localStorage.ID = UUID; //store UUID on client
        }
        console.log(UUID);
        localStorage.lastPage = document.location.href;
      }

      function checkLength() { //write character count of currently typed comment
        document.getElementById("length").value = document.getElementById("comment").value.length + "/1024"
      }

      function processData(data) {
        console.debug(data)
        // strip rogue tags
        let sanitsiedText = data.replace( /(<([^>]+)>)/ig, '');
        if (sanitsiedText == ""){
          throw new Error('Empty string!');
        }
        console.debug(sanitsiedText)
        return toHyperlink(sanitsiedText)
      }

      function toHyperlink(text) {
        // Create a regular expression to match URLs.
        const urlRegex = /(https?:\/\/[-A-Za-z0-9+&@#\/%?=~_|!:,.;]*)/g;

        // Replace all URLs with `<a>` tags.
        return text.replace(urlRegex, function(match) {
          return `<a href="${match}">${match}</a>`;
        });
      }

      function deleteComment(ID){
        const db = firebase.firestore(); // init database
        const commentRef = db.collection(getPage()+"page").doc(ID.toString()) // get correct page and document
        commentRef.delete().then(() => {
          console.log("Comment deleted");
        }).catch((error) => {
          console.error("Error removing comment: ", error);
        });
      }

      function editComment(originalComment, ID){
        let edit = window.prompt(originalComment, "Type your comment here...")
        editCommentConfirm(edit, ID)
      }

      function editCommentConfirm(edit, ID){
        const db = firebase.firestore(); // init database
        const commentRef = db.collection(getPage()+"page").doc(ID.toString()) // get correct page and document
        commentRef.update({
          comment: edit + ` <span class="edited">(Edited)</span>`, // edit comment
        })
        .then(docRef => {
          console.log("Comment edited: ", ID.toString());
        })
        .catch(error => {
            console.error("Error editing comment: ", error);
        });
      }

      function commentCount(){return document.getElementById("commentCount").innerHTML.toString()}
    </script>

    <script type="module">
      try{
        var url = new URL(document.referrer);
        url = url.hostname;
      }catch(e){
        var url = "basepage"; //default page incase of error
      }
      const config = {
        //replace with your keys
        apiKey: "AIzaSyAux2JUqc-2vJJHccbOsDVcH7XUAG5BHaU",  
        projectId: "kinositecomments" 
      };
    
      //init cloud firestore through firebase()
      const db = firebase.firestore();
      const form = document.querySelector("form"); //store page elements
      const nickname = document.getElementById("nickname");
      const comment = document.getElementById("comment");
      const dataArea = document.getElementById("loaddata");

      form.addEventListener('keydown', (event) => {
          if(event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
              submitForm()
          }
      });

    form.addEventListener("submit", e => {
      e.preventDefault();
      submitForm()
    });

    function submitForm() {
      if (comment.value) { //client check comment conditions
        let fillednickname = "anon" // if nickname box is left blank name them 'anon'
        if (nickname.value) fillednickname = nickname.value

        const commentRef = db.collection(getPage()+"page").doc(commentCount())
        commentRef.set({
            nickname: fillednickname,
            comment: processData(comment.value),
            date: new Date(),
            deviceID: localStorage.ID,
            ID: commentCount()
        }).then(docRef => {
          console.log("Comment sent");
        }).catch(error => {
          console.error("Error adding comment: ", error);
        });
        comment.value = "";
        checkLength()
      }
      else{
        comment.value = "";
        checkLength()
      }
    }

    if (url == "zydezu.github.io" || window.location.hostname == "kinositecomments.web.app"){ //replace url (hostname only) with the page you will embed this site on
      if (url != "zydezu.github.io"){
        window.history.replaceState(null, '', window.location.pathname); //redirect kinositecomments.web.app/?page=WHATEVER to base page, so non-existent pages cant be made
        document.body.style.backgroundColor = "#000000";
      }
      db
        .collection(getPage()+"page") //group by page
        .orderBy("date")
        .onSnapshot(querySnapshot => {
          let comments = [];
          querySnapshot.forEach(chat => {
            comments.push(chat.data());
          });

          if (comments.length !== 0) { //check comment count and update
            dataArea.innerHTML = "";
            document.getElementById("commentCount").innerHTML = comments.length;
          }
          else {
            dataArea.innerHTML = "<p>No comments</p>"; //no comments
            document.getElementById("commentCount").innerHTML = comments.length;
          }

          // loop through all the comments collected
          for (let i = comments.length-1; i > -1 ; i--) {
            let date = new Date(comments[i].date.seconds * 1000);
            console.log(date)

            let hours = "0" + date.getHours();
            let minutes = "0" + date.getMinutes();
            let createdOn = date.toLocaleDateString() + " " + hours.substr(-2) + ':' + minutes.substr(-2); // format time and date
            console.log(createdOn)

            if (comments[i].deviceID == localStorage.ID){ //check if comment was posted by you
              dataArea.innerHTML += 
            `<article id=${comments[i].commentID}><p><b>${comments[i].nickname}</b> <em>${createdOn}</em> | <button onclick="editComment(${comments[i].comment}, ${comments[i].commentID})">Edit</button> <button onclick="deleteComment(${comments[i].commentID})">Delete</button> <br/>${comments[i].comment}</p></article>`;
            } else { // comments not written by you
              dataArea.innerHTML += 
            `<article id=${comments[i].commentID}><p><b>${comments[i].nickname}</b> <em>${createdOn}</em><br/>${comments[i].comment} </p></article>`; 
            }
          }
          sendHeightMessage()
      });
    }
    else{
      dataArea.innerHTML = "Invalid page"; // if embed is on a page its not supposed to be on
    }
    </script>
</body>
</html>